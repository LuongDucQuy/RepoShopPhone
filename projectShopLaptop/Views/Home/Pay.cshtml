@using projectShopLaptop.Models
@using projectShopLaptop.Models.Home
@model projectShopLaptop.DAL.Tbl_User
@{
    ViewBag.Title = "Thanh toán";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<link href="~/AdminStyle/css/Pay.css" rel="stylesheet" />
<style>
    .promo-code-form {
        margin: 20px 0;
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        justify-content: space-between;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 20px;
        background-color: #fdfdfd;
        box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
    }

        .promo-code-form:hover {
            box-shadow: 0px 6px 15px rgba(0, 0, 0, 0.2);
        }

        .promo-code-form input[type="text"] {
            flex: 1;
            margin-right: 10px;
            padding: 12px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-shadow: inset 0px 1px 3px rgba(0, 0, 0, 0.1);
            transition: border-color 0.3s ease;
        }

            .promo-code-form input[type="text"]:focus {
                border-color: #007bff;
                box-shadow: 0px 0px 5px rgba(0, 123, 255, 0.5);
                outline: none;
            }

        .promo-code-form button {
            padding: 10px 25px;
            font-size: 16px;
            background-color: #28a745;
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

            .promo-code-form button:hover {
                background-color: #218838;
            }
    #PromoMessage {
        margin-top: 10px;
        font-size: 16px;
        font-weight: bold;
        padding: 10px;
        border-radius: 5px;
        display: none; /* Ẩn thông báo ban đầu */
        transition: all 0.3s ease-in-out;
    }

        /* Màu xanh cho thành công */
        #PromoMessage.success {
            color: #155724;
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
        }

        /* Màu đỏ cho lỗi */
        #PromoMessage.error {
            color: #721c24;
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
        }

</style>
@if (Session["cart"] == null)
{
    <div class="alert alert-danger">
        <strong>No product added to cart!</strong>
    </div>
}
else
{
    var cart = (List<Item>)Session["cart"];
    if (cart != null)
    {
        <section class="main-container col2-right-layout">
            <div class="main container">
                <div class="row">
                    <div class="col-main col-sm-12 col-xs-12">
                        <div class="page-title">
                            <h2>Thanh toán</h2>
                        </div>
                        <div class="page-content checkout-page">
                            <h6 class="checkout-sep">1. Tóm tắt đơn hàng</h6>
                            <div class="box-border">
                                <div class="table-responsive">
                                    <table class="table table-bordered cart_summary" id="tbl_cart">
                                        <thead>
                                            <tr>
                                                <th>Tên sản phẩm</th>
                                                <th>Giá</th>
                                                <th>Số lượng</th>
                                                <th>Tổng tiền</th>
                                            </tr>
                                        </thead>
                                        <tbody class="cart_body">
                                            @{
                                                int total = 0;
                                            }
                                            @foreach (var item in cart)
                                            {
                                                if (item != null && item.Product != null)
                                                {
                                                    int tienSP = Convert.ToInt32(item.Quantity * item.Product.Price);
                                                    total += tienSP;
                                                    <tr>
                                                        <td>@item.Product.ProductName</td>
                                                        <td>@string.Format(new System.Globalization.CultureInfo("vi-VN"), "{0:C0}", item.Product.Price)</td>
                                                        <td>@item.Quantity</td>
                                                        <td>@string.Format(new System.Globalization.CultureInfo("vi-VN"), "{0:C0}", tienSP)</td>
                                                    </tr>
                                                }
                                                {
                                                    ViewBag.TotalAmount = total;
                                                }
                                            }
                                        </tbody>
                                        <tfoot>
                                            <tr>
                                                <td colspan="2"></td>
                                                <td><strong>Tổng giá đơn hàng</strong></td>
                                                <td>@string.Format(new System.Globalization.CultureInfo("vi-VN"), "{0:C0}", total)</td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                                <div class="promo-code-form">
                                    <input type="text" id="PromoCode" name="PromoCode" placeholder="Nhập mã giảm giá tại đây" />
                                    <button type="button" id="ApplyPromoCode" onclick="applyPromoCode()">Áp dụng</button>
                                </div>
                                <div>
                                    <span id="PromoMessage"></span>
                                </div>

                            </div>
                            <h6 class="checkout-sep">2. Phương thức thanh toán</h6>
                            <div class="box-border">
                                <form>
                                    <ul>
                                        <li class="row">
                                            <div class="col-sm-6">
                                                <label class="required">Thanh toán khi nhận hàng</label>
                                            </div>
                                        </li>
                                        <li class="row">
                                            <div class="col-sm-6">
                                                <label>Hoặc</label>
                                            </div>
                                        </li>
                                        <li class="row">
                                            <div class="col-sm-6">
                                                <a href="@Url.Action("VnPay", "Home", new { Tongtien = total, Name = ViewBag.Name, Address = ViewBag.Address, PhoneNumber = ViewBag.PhoneNumber })" class="btn btn-primary">PAY WITH CARD</a>
                                            </div>
                                        </li>
                                    </ul>
                                </form>
                            </div>
                            <h6 class="checkout-sep">3. Thông tin giao hàng</h6>
                            <div class="box-border">
                                <form action="@Url.Action("Checkout", "Home")" method="post" onsubmit="confirmOrder(event)">
                                    <ul>
                                        <li class="row">
                                            <div class="col-sm-6">
                                                <label for="Name" class="required">Tên</label>
                                                <input class="input form-control" id="txt_name_cod" type="text" name="Name" value="@ViewBag.Name" required>
                                            </div>
                                        </li>
                                        <li class="row">
                                            <div class="col-sm-6">
                                                <label for="Address" class="required">Địa chỉ</label>
                                                <input class="input form-control" id="txt_address_cod" type="text" name="Address" value="@ViewBag.Address" required>
                                            </div>
                                        </li>
                                        <li class="row">
                                            <div class="col-sm-6">
                                                <label for="PhoneNumber" class="required">Số điện thoại</label>
                                                <input class="input form-control" id="txt_phone_cod" type="text" name="PhoneNumber" value="@ViewBag.PhoneNumber" required>
                                            </div>
                                        </li>
                                    </ul>
                                    <button type="submit" class="btn btn-primary">Đặt hàng</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    }
}
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script type="text/javascript">
    // Hàm xác nhận việc đặt hàng
    function confirmOrder(event) {
        // Hiển thị hộp thoại xác nhận
        var isConfirmed = confirm("Bạn chắc chắn muốn đặt hàng?");

        // Nếu người dùng chọn "OK", form sẽ được gửi đi
        if (!isConfirmed) {
            event.preventDefault(); // Ngừng hành động submit nếu người dùng chọn "Cancel"
        }
    }</script>
<script>
    function applyPromoCode() {
    var promoCode = document.getElementById("PromoCode").value;

    // Kiểm tra mã giảm giá trống
    if (!promoCode) {
        showPromoMessage("Vui lòng nhập mã giảm giá.", "error");
        return;
    }

    // Gửi mã giảm giá qua AJAX
    $.ajax({
        url: '@Url.Action("ApplyPromoCode", "Home")',
        type: 'POST',
        data: { promoCode: promoCode },
        success: function (response) {
            if (response.success) {
                // Cập nhật tổng tiền sau giảm giá
                $('#tbl_cart tfoot tr:last-child td:last-child').text(response.totalAfterDiscount);

                // Hiển thị thông báo thành công
                showPromoMessage(response.message, "success");
            } else {
                // Hiển thị thông báo lỗi
                showPromoMessage(response.message, "error");
            }
        },
        error: function () {
            showPromoMessage("Đã xảy ra lỗi. Vui lòng thử lại.", "error");
        }
    });
}

// Hàm hiển thị thông báo
function showPromoMessage(message, type) {
    var promoMessage = document.getElementById("PromoMessage");
    promoMessage.innerText = message;
    promoMessage.className = ""; // Xóa class cũ
    promoMessage.classList.add(type); // Thêm class theo loại (success/error)
    promoMessage.style.display = "block"; // Hiển thị

    // Ẩn thông báo sau 5 giây
    setTimeout(function () {
        promoMessage.style.display = "none";
    }, 5000);
}

</script>
